<html>

<head>
    <title>
        test content
    </title>
    <script src="./w3.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="./w3.css" />
    <link rel="stylesheet" href="./css/bootstrap.min.css" />
    <script src="./jquery-3.3.1.min.js"></script>
    <script src="./js/bootstrap.min.js"></script>
    <style>
        body {
            min-width: 99vw;
        }
        
        .fill {
            width: 99vw;
            height: 20vh;
        }
        
        .ifill {
            width: 99.99%;
            /* height: 99.99%; */
            object-fit: cover;
        }
        
        .title {
            height: 10em;
        }
        
        .bgi {
            background-image: url(./timthumb.php.jpg);
            background-position: 50%, 50%;
            background-size: cover;
        }
        
        .eas {
            transition: all 300ms ease-in-out;
            overflow: hidden !important;
        }
        
        .eas:hover img {
            transform: scale(1.05);
        }
        
        img {
            transition: all 300ms ease-in-out;
        }
        
        .noover {
            overflow: hidden !important;
        }
        
        .xxxsmall {
            max-width: 48px;
        }
        
        .content {
            height: 50px;
        }
        
        @media print {
            /* body {}
            page[size="A4"] {
                margin: 0;
                box-shadow: 0;
            }
            page[size="A4"] {
                background: white;
                width: 21cm;
                height: 29.7cm;
                display: block;
                margin: 0 auto;
                margin-bottom: 0.5cm;
                box-shadow: 0 0 0.5cm rgba(0, 0, 0, 0.5);
            }*/
        }
    </style>
</head>

<body class="w3_row w3-container">
    <!-- <section class="w3-section w3-container ">
        <div class="w3-card-4 w3-col m12 s12 l12 eas fill">
            <img class="ifill" src="./timthumb.php.jpg" alt="parallaxadf" />
             <span class="bgi ifill"></span>
        </div>
    </section>-->
    <page size="A4">
        <div class="w3-col l1 w3-hide-small w3-hide-medium w3-right">
            <p class="w3-container w3-amber">controls</p>
            <div class="w3-card-4 ">
                <div class="w3-container w3-black">
                    <h3>Page Controls</h3>
                </div>
                <div class="w3-content w3-teal">
                    <label for="issueType">Options</label>
                    <select name="issueType" class="w3-select">
                                <option value="Tasks">Tasks</option>
                                <option value="subtasks">Sub-Tasks</option>
                            </select>
                    <select name="status" class="w3-select">
                                    <option value="-">All</option>
                                    <option value="todo">To Do</option>
                                    <option value="inpr">In Progress</option>
                                    <option value="qa">QA</option>
                            </select>
                    <input class="w3-input" name="start" type="number" placeholder="Starting Point" />
                    <input class="w3-input" name="end" type="number" placeholder="End Point" />
                    <button class="w3-btn w3-green" onclick="btn.previous()"> << </button>
                    <button class="w3-btn w3-green" onclick="btn.next()"> >> </button>
                    <button class="w3-btn w3-red" onclick="btn.do_()">X</button>
                </div>
            </div>
        </div>
        <section class=" sec_0 ">
            <div class="w3-card w3-margin-top w3-margin-right  w3-border w3-border-dark-gray w3-col l5 s5">
                <div class="w3-container w3-left-align title">
                    <h3>
                        <p>work</p>
                    </h3>
                </div>
                <div class="w3-content content noover">
                </div>
                <div class="footer w3-container footer">
                    <h4 class="w3-left"></h4>
                    <h4 class="w3-right"></h4>
                </div>
            </div>
        </section>
        <!-- <section class="  w3-margin-right sec_1 w3-col l5 s5"></section> -->

    </page>
    <page size="A4">
        <section class="  w3-margin-right sec_2 w3-col l5 s5"></section>
        <section class="  w3-margin-right sec_3 w3-col l5 s5"></section>
    </page>
    <page size="A4">
        <section class=" w3-margin-right sec_4 w3-col l5 s5"></section>
        <section class="  w3-margin-right sec_5 w3-col l5 s5"></section>
    </page>


    <script>
        var data = {
            d: undefined,
            cards: undefined,
            do_: function(start, dtyp, t, end) {
                // **  setup
                $("section").empty();
                var c = 0;
                var startAt = start !== undefined ? start : 0; //error handling for optional
                var endAt = end !== undefined ? end : 10;
                var datatype = dtyp !== undefined ? dtyp : "Tasks";
                var tag = t !== undefined ? t : "-";

                var ilen = data.d.issues.length;
                var lptil = startAt + endAt > ilen ? ilen : startAt + endAt
                lptil = tag !== '-' ? ilen : lptil;
                // ** end setup
                if (data.d.issues !== undefined && datatype === "Tasks") {
                    for (var a = startAt; a < lptil; a++) {
                        var card = $(data.card).clone(true);
                        post = data.d.issues[a];
                        var pointer = c / 5;
                        var appento = ".sec_0"; // + Math.floor(pointer).toString();
                        //TODO: filter By Tag
                        if (data.filter_tags(tag, post.fields.status.id)) {
                            var assignee = post.fields.assignee ? post.fields.assignee.displayName.trim() : "-";
                            var asa = assignee !== '-' ? assignee.split(" ") : "";
                            var initials = assignee !== '-' ? asa[0][0] + asa[asa.length - 1][0] : "";
                            var cont = (post.fields.assignee ?
                                    "<img class='w3-circle xxxsmall w3-right w3-margin-right' src='" +
                                    initials.toString().toLowerCase() + ".png'/>" : "") +
                                "<p class='w3-center'>" + post.fields.project.name + "</p>";

                            $(card).find(".title h3 p").text(post.fields.summary ? post.fields.summary : "Not set");
                            $(card).addClass(data.color[post.fields.priority.id]);
                            $(card).find(".content").html(cont);
                            $(card).find(".footer h4.w3-left").text(post.fields.customfield_10021 ? post.fields.customfield_10021 : "-");
                            $(card).find(".footer h4.w3-right").text(assignee);
                            $(appento).append(card);
                            c = c + 1;
                        }



                    }
                } else if (datatype === "subtasks") {
                    for (var a = startAt; a < lptil; a++) {
                        var card = $(data.card).clone(true);
                        post = data.d.issues[a];
                        var pointer = c % 5;
                        var assignee = post.fields.assignee ? post.fields.assignee.displayName.trim() : "-";
                        $(card).find(".footer h4.w3-right").text(assignee);
                        if (post.fields.subtasks.length > 0) {
                            $(card).find(".title h3 p").text(post.fields.summary ? post.fields.summary : "Not set");
                            var asa = assignee !== '-' ? assignee.split(" ") : "";
                            var initials = assignee !== '-' ? asa[0][0] + asa[asa.length - 1][0] : "";
                            var cont = "<p class='w3-center'>" + post.fields.project.name + "</p>";
                            var img = (post.fields.assignee ?
                                "<img class='w3-circle xxxsmall w3-right w3-margin-right' src='" +
                                initials.toString().toLowerCase() + ".png'/>" : "");
                            var appento = ".sec_0"; // + Math.floor(pointer).toString();
                            $(card).find(".content").html(img + cont);
                            $(appento).append(card);
                            var sub = post.fields.subtasks;
                            sub.forEach(p => {
                                if (data.filter_tags(tag, p.fields.status.id)) {
                                    card = $(data.card).clone(true);
                                    $(card).find(".title h3 p").text(p.fields.summary ? p.fields.summary : "Not set");
                                    $(card).addClass(data.color[p.fields.priority.id]);
                                    $(card).find(".content").html(cont);
                                    var assignee = p.fields.assignee ? p.fields.assignee.displayName.trim() : "-";
                                    $(card).find(".footer h4.w3-right").text(assignee);
                                    $(appento).append(card);
                                }
                            });
                            c = c + 1;
                        }

                    }
                }
                console.log(lptil);
                $("img").on('error',
                    function() {
                        $(this).hide();
                    }
                );

            },
            color: ["w3-grey", "w3-dark-grey", "w3-orange", "w3-pink", "w3-red", ""],
            tags: {
                todo: ["10300", "10000", "10100"],
                inpr: ["3"],
                qa: ["10002"]
            },
            filter_tags: function(t, f) {
                var ret = false;
                switch (t) {
                    case "-":
                        return true;
                    case "todo":
                        data.tags.todo.forEach(t => {
                            if (t === f)
                                ret = true;
                        });
                        return ret;
                    case "inpr":
                        data.tags.inpr.forEach(t => {
                            if (t === f)
                                ret = true;
                        });
                        return ret;
                    case "qa":
                        data.tags.qa.forEach(t => {
                            if (t === f)
                                ret = true;
                        });
                        return ret;
                }

            }
        }
        $(document).ready(function() {
            try {
                pull();
            } catch (ex) {
                console.log(ex);
            }
        });
        /*$('video').on("mouseover", function(e) {
            var video = e.target;
            if (video.readyState === 4); {
                video.currentTime = parseFloat(parseInt(video.seekable.end(0.42) / 4));
                setTimeout(function() {
                    video.currentTime = parseFloat(parseInt(video.seekable.end(0.42) / 2));
                    setTimeout(function() {
                        video.currentTime = parseFloat(parseInt(video.seekable.end(0.42) / (1.3333333)));
                    }, 500);
                }, 500);
            }
        });*/
        function pull() {
            data.cards = document.querySelectorAll(".w3-card");
            data.card = $(data.cards[0]).clone(true);
            data.color.reverse();
            $(data.cards[0]).remove();
            $.getJSON("./g.php", function(res) {
                console.log(res);
                data.d = res;
                data.do_();
            });
        }
        var btn = {
            pointer: 0,
            next: function() {
                var cfg = btn.config();
                var cnt = cfg.end !== "" ? cfg.end : 10;
                console.log(btn.pointer, ">", cnt);
                btn.pointer = (btn.pointer + cnt) < data.d.issues.length ? btn.pointer + parseInt(cnt) : 0;

                data.do_(parseInt(btn.pointer), cfg.issueType, cfg.status, parseInt(cnt));
            },
            previous: function() {
                var cfg = btn.config();
                var cnt = cfg.end !== "" ? cfg.end : 10
                btn.pointer = (btn.pointer - parseInt(cnt)) > 0 ? btn.pointer - parseInt(cnt) : 0;
                data.do_(parseInt(btn.pointer), cfg.issueType, cfg.status, parseInt(cnt));
            },
            config: function() {
                var inputs = $("input").serializeArray();
                var options = $("select").serializeArray();
                var args = {};
                inputs.forEach(i => {
                    args[i.name] = i.value;
                });
                options.forEach(o => {
                    args[o.name] = o.value
                });
                console.log(args);
                return args;
            },
            do_: function() {
                var cfg = btn.config();
                var cnt = cfg.end !== "" ? cfg.end : 10;
                var start = cfg.start !== "" ? cfg.start : 0;
                data.do_(parseInt(start), cfg.issueType, cfg.status, parseInt(cnt));
            }
        }
    </script>
</body>

</html>